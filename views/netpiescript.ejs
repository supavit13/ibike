<script src="https://cdn.netpie.io/microgear.js"></script>

<!-- <script src="https://raw.githubusercontent.com/netpieio/microgear-html5/master/src/index.js"></script> -->
<script>
    var mId = JSON.parse('<%- JSON.stringify(mId) %>');
    $("#start").on("click", function () {
        console.log("staaaart");
        if (document.getElementById("checkbox").checked) {
            microgear.publish("/"+mId+"/startengine", "1");
            console.log("staaaart1");
        } else {
            microgear.publish("/"+mId+"/startengine", "0");
            console.log("staaaart0");
        }
    });
    var APPID = "CMRM";
    var APPKEY = "Q22q476p7toHHLD";
    var APPSECRET = "x2ttOOD1vJqbqN5M9sJFdJO6Q";
    var ALIAS = "web";

    var microgear = Microgear.create({
        key: APPKEY,
        secret: APPSECRET,
        alias: ALIAS /*  optional  */
    });
    // var ackDevice = "";
    var $his = {};
    var state = 0;
    var i = 0;
    microgear.on('message', function (topic, msg) {
        console.log("in receive");
        console.log(msg);
        var currentUrl = window.location.href;
        currentUrl = currentUrl.split("/")[currentUrl.split("/").length-1];
        console.log(currentUrl);
        if(currentUrl == "riding"){
            state=1;
        }
        if (msg == "1") {
            window.location.replace("/riding");
        }
        else if (msg == "0") {
            window.location.href = "/showbike";
        }
        else if(topic == "/CMRM/"+mId+"/location"){
            console.log(msg.split(",")[0]);
            var latlng = {
                lat: msg.split(",")[0],
                lng: msg.split(",")[1]
            }
            var point = new google.maps.LatLng(parseFloat(msg.split(",")[0]), parseFloat(msg.split(",")[1]));
            if (!google.maps.geometry.poly.containsLocation(point, setZone)) {
                swal("You out of area");
                socket.emit('alert', "Report Motorcycle out of area id : "+morcycID +" by userId : "+userId );
            }
            
            // $.extend($his,latlng);
            console.log(Object.keys($his).length);
            var len = Object.keys($his).length;
            if (len < 30) {
                $his[i] = latlng;
                i++;
            } else {
                $.ajax({
                    type: 'POST',
                    url: 'morcyc/getlatlng',
                    data: {
                        '_token': $('input[name=_token]').val(),
                        morcycID: morcycID,
                        his: $his
                    },
                    success: function (data) {
                        console.log(data);
                        if (data == true) {
                            console.log("save log succcessed");
                        }
                    }
                });
                i = 0;
                $his = {};
            }


        }
        // document.getElementById("data").innerHTML = msg;
    });

    microgear.on('connected', function () {
        microgear.setAlias(ALIAS); /* alias can be renamed anytime with this function */
        // document.getElementById("data").innerHTML = "Now I am connected with netpie...";
        microgear.subscribe("/"+mId+"/ackDevice");
        if(state){
            microgear.subscribe("/"+mId+"/location");
        }
        

    });

    microgear.on('present', function (event) {
        console.log(event);
    });

    microgear.on('absent', function (event) {
        console.log(event);
    });
    microgear.connect(APPID);
    $("#stopButton").on("click", function () {
        console.log("stop");
        swal({
            title: "Do you want to turn off engine?",
            text: "Please press OK when you want to stop driving and pay money.",
            icon: "info",
            buttons: true,
            dangerMode: true,
        })
            .then((willDelete) => {
                if (willDelete) {
                    swal("Thank you", {
                        icon: "success",
                    });
                    turnOff();
                } else {
                    swal("Continue.");
                }
            });


        // if (confirm("Do you want to turn off engine?")) {
        //     // time.stop();
        //     money = 0;
        //     microgear.publish("/startengine", "0");
        //     console.log("conf");
        // }
    });
    function turnOff() {
        $.ajax({
            type: "POST",
            url: "/morcyc/turnoff",
            data: {
                '_token': $('input[name=_token]').val()
            },
            success: function (data) {
                if (data) {
                    money = 0;
                    microgear.publish("/"+mId+"/startengine", "0");
                    console.log("conf");
                    timer.stop();
                } else {
                    swal(data);
                }
            }
        });
    }
</script>