<script>
    var mymap = L.map('map', {
        center: new L.LatLng(13.1192, 100.92066),
        zoom: 16,
    });
    var polygon = [[21.22794, 90.79102], [3.73271, 90.79102], [4.82826, 115.00488], [21.30985, 115.00488]];

    var json = '<%- JSON.stringify(zone) %>';
    window.onload = function () {
        if (json == '') {
            location.reload();
        }
    };

    // var json = JSON.parse(htmlDecode("<%= JSON.stringify(zone) %>"));
    var dbzone = JSON.parse(json);
    dbzone = dbzone[0]['zone'];
    console.log(dbzone);
    var setArea = L.polygon(dbzone).addTo(mymap);
    setArea.setStyle({ "fillOpacity": 0, color: 'red' });
    mymap.setMaxBounds(polygon);


    L.gridLayer.googleMutant({
        minZoom: 6,
        type: 'roadmap' // valid values are 'roadmap', 'satellite', 'terrain' and 'hybrid'
    }).addTo(mymap);

    // var greenIcon = new LeafIcon({iconUrl: '/images/markar.png'});
    mymap.addControl(L.control.locate({
        // iconUrl: '/images/markar.png',
        locateOptions: {
            enableHighAccuracy: true
        }
    }));




    var greenIcon = L.icon({
        iconUrl: '/images/rsz_blue.png',
        // shadowUrl: 'leaf-shadow.png',
        iconSize: [42, 94], // size of the icon
    });
    var userIcon = L.icon({
        iconUrl: '/images/user_icon.png',
        iconSize: [50, 50], // size of the icon
    });

    var mylat;
    var mylng;
    var current_position, current_accuracy;

    function onLocationFound(e) {
        // if position defined, then remove the existing position marker and accuracy circle from the map
        if (current_position) {
            mymap.removeLayer(current_position);
            // mymap.removeLayer(current_accuracy);
        }

        var radius = e.accuracy / 2;

        mylat = e.latlng.lat;
        mylng = e.latlng.lng;
        current_position = L.marker(e.latlng, { icon: userIcon }).addTo(mymap);
        // current_position = L.marker(e.latlng, { icon: userIcon }).addTo(mymap)
        //     .bindPopup("You are within " + radius + " meters from this point").openPopup();

        // current_accuracy = L.circle(e.latlng, radius).addTo(mymap);
    }

    function onLocationError(e) {
        if (e.message != null) {
            if (e.message == "Geolocation error: Timeout expired.") {
                console.log(e.message);
            } else {
                console.log(e.message);
            }
        }

    }

    mymap.on('locationfound', onLocationFound);
    mymap.on('locationerror', onLocationError);

    // wrap map.locate in a function    
    function locate() {
        mymap.locate({ setView: false, maxZoom: 16 });
    }


    var lat;
    var lng;
    var routing;
    var clickMarker = false;
    var morcyc = JSON.parse('<%- JSON.stringify(morcyc) %>');
    // console.log(morcyc);
    // locate();
    setInterval(function () {
        locate();
    }, 1000);
    for (var i = 0; i < morcyc.length; i++) {
        var lat = parseFloat(morcyc[i]['latlng']['lat']);
        var lng = parseFloat(morcyc[i]['latlng']['lng']);
        var name = morcyc[i]['name'];
        
        if (morcyc[i]['using'] != "yes") {
            // console.log(morcyc[i]['name']+" "+lat+" "+lng);
            var m1 = L.marker([lat, lng], { icon: greenIcon, morcycId: morcyc[i]['_id'] }).addTo(mymap).bindPopup(name).on('click', function (e) {
                document.getElementById("booking").disabled = false;
                document.getElementById("repairing").disabled = false;
                $("#repairing").data('id', e.target.options["morcycId"]);
                $("#booking").data('id', e.target.options["morcycId"]);
                console.log("morcycId : " + e.target.options["morcycId"]);
                if (routing != null) {
                    routing.spliceWaypoints(0, 2);
                    mymap.removeControl(routing);
                }
                lat = e.latlng.lat;
                lng = e.latlng.lng;
                clickMarker = true;
                var ways = {
                    waypoints:
                        [
                            L.latLng(mylat, mylng),
                            L.latLng(lat, lng)
                        ]
                };
                routing = L.Routing.control(ways).addTo(mymap);
                // mymap.removeControl(routing);
            });
            console.log("name: " + morcyc[i]['name'] + " " + setArea.contains(m1.getLatLng()));
        }
    }
    function clickRepair() {
        window.location.replace("/repair/" + $("#repairing").data("id"));
    }

    $(document).on("click touchstart tap", "#booking", function () {
        if (document.getElementById("booking").disabled == false) {
            var morcycID = $("#booking").data("id");
            $.ajax({
                type: "POST",
                url: "/booking",
                data: {
                    '_token': $('input[name=_token]').val(),
                    morcycID: morcycID
                },
                success: function (data) {
                    if (data) {
                        window.location.replace("/start");
                    } else {
                        swal(data);
                    }
                }
            });
        }
    });
    function onMapClick(e) {
        document.getElementById("booking").disabled = true;
        $("#booking").data('id', "");
        document.getElementById("repairing").disabled = true;
        $("#repairing").data('id', "");
        lat = e.latlng.lat;
        lng = e.latlng.lng;
        if (routing != null) {
            routing.spliceWaypoints(0, 2);
            mymap.removeControl(routing);
        }
        lat = e.latlng.lat;
        lng = e.latlng.lng;
        clickMarker = true;
        var ways = {
            waypoints:
                [
                    L.latLng(mylat, mylng),
                    L.latLng(lat, lng)
                ]
        };
        console.log(ways);
        // alert(lat + "," + lng);
        routing = L.Routing.control(ways).addTo(mymap);
        // mymap.removeControl(routing);
    }
    mymap.on('click', onMapClick);



</script>